<?xml version="1.0" encoding="UTF-8"?>
<resource oid="ldap-resource-oid"
          xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3"
          xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3">

    <name>OpenLDAP Resource</name>
    <description>Connecteur LDAP pour OpenLDAP</description>

    <connectorRef type="ConnectorType">
        <filter>
            <q:equal xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3">
                <q:path>connectorType</q:path>
                <q:value>com.evolveum.polygon.connector.ldap.LdapConnector</q:value>
            </q:equal>
        </filter>
    </connectorRef>

    <connectorConfiguration>
        <icfc:configurationProperties xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3"
                                      xmlns:icfcldap="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.evolveum.polygon.connector-ldap/com.evolveum.polygon.connector.ldap.LdapConnector">

            <!-- Paramètres de connexion LDAP -->
            <icfcldap:host>openldap</icfcldap:host>
            <icfcldap:port>389</icfcldap:port>
            <icfcldap:baseContext>dc=example,dc=com</icfcldap:baseContext>
            <icfcldap:bindDn>cn=admin,dc=example,dc=com</icfcldap:bindDn>
            <icfcldap:bindPassword>
                <t:clearValue xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3">secret</t:clearValue>
            </icfcldap:bindPassword>

            <!-- Type de connexion -->
            <icfcldap:connectionSecurity>none</icfcldap:connectionSecurity>

            <!-- Configuration des objets -->
            <icfcldap:vlvSortAttribute>uid</icfcldap:vlvSortAttribute>
            <icfcldap:operationalAttributes>memberOf</icfcldap:operationalAttributes>
            <icfcldap:operationalAttributes>createTimestamp</icfcldap:operationalAttributes>

        </icfc:configurationProperties>

        <icfc:resultsHandlerConfiguration xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3">
            <icfc:enableNormalizingResultsHandler>false</icfc:enableNormalizingResultsHandler>
            <icfc:enableFilteredResultsHandler>false</icfc:enableFilteredResultsHandler>
            <icfc:enableAttributesToGetSearchResultsHandler>false</icfc:enableAttributesToGetSearchResultsHandler>
        </icfc:resultsHandlerConfiguration>
    </connectorConfiguration>

    <!-- Schéma LDAP -->
    <schemaHandling>
        <objectType>
            <kind>account</kind>
            <intent>default</intent>
            <displayName>Default Account</displayName>
            <default>true</default>
            <objectClass>ri:inetOrgPerson</objectClass>

            <!-- Mapping des attributs -->
            <attribute>
                <ref>ri:dn</ref>
                <displayName>Distinguished Name</displayName>
                <outbound>
                    <source>
                        <path>$user/name</path>
                    </source>
                    <expression>
                        <script>
                            <code>
                                'uid=' + name + ',ou=people,dc=example,dc=com'
                            </code>
                        </script>
                    </expression>
                </outbound>
            </attribute>

            <attribute>
                <ref>ri:uid</ref>
                <displayName>Login Name</displayName>
                <outbound>
                    <source>
                        <path>$user/name</path>
                    </source>
                </outbound>
            </attribute>

            <attribute>
                <ref>ri:cn</ref>
                <displayName>Common Name</displayName>
                <outbound>
                    <source>
                        <path>$user/fullName</path>
                    </source>
                </outbound>
            </attribute>

            <attribute>
                <ref>ri:sn</ref>
                <displayName>Surname</displayName>
                <outbound>
                    <source>
                        <path>$user/familyName</path>
                    </source>
                </outbound>
            </attribute>

            <attribute>
                <ref>ri:givenName</ref>
                <displayName>Given Name</displayName>
                <outbound>
                    <source>
                        <path>$user/givenName</path>
                    </source>
                </outbound>
            </attribute>

            <attribute>
                <ref>ri:mail</ref>
                <displayName>Email</displayName>
                <outbound>
                    <source>
                        <path>$user/emailAddress</path>
                    </source>
                </outbound>
            </attribute>

            <activation>
                <administrativeStatus>
                    <outbound/>
                </administrativeStatus>
            </activation>

        </objectType>
    </schemaHandling>

    <capabilities>
        <cachingMetadata>
            <retrievalTimestamp>2025-12-03T00:00:00.000Z</retrievalTimestamp>
        </cachingMetadata>
        <native xmlns:cap="http://midpoint.evolveum.com/xml/ns/public/resource/capabilities-3">
            <cap:addRemoveAttributeValues/>
            <cap:activation>
                <cap:status/>
            </cap:activation>
        </native>
    </capabilities>

    <synchronization>
        <objectSynchronization>
            <enabled>true</enabled>
            <kind>account</kind>
            <intent>default</intent>
            <focusType>UserType</focusType>

            <reaction>
                <situation>linked</situation>
                <synchronize>true</synchronize>
            </reaction>

            <reaction>
                <situation>deleted</situation>
                <synchronize>true</synchronize>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#unlink</handlerUri>
                </action>
            </reaction>

            <reaction>
                <situation>unlinked</situation>
                <synchronize>true</synchronize>
                <action>
                    <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link</handlerUri>
                </action>
            </reaction>

            <reaction>
                <situation>unmatched</situation>
            </reaction>
        </objectSynchronization>
    </synchronization>

</resource>
