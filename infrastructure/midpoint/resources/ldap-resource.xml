<?xml version="1.0" encoding="UTF-8"?>
<!--
  LDAP resource definition for ApacheDS integration with MidPoint.
  This connects to the ApacheDS container running in docker-compose.

  Import this file from the midPoint UI: Configuration -> Import object
-->
<resource xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
          xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3"
          xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3"
          xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3"
          xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3"
          xmlns:mr="http://prism.evolveum.com/xml/ns/public/matching-rule-3"
          oid="8a8b9c1d-0001-0000-0000-000000000001">

  <name>ApacheDS LDAP Resource</name>
  <description>LDAP resource for ApacheDS - Example Corp directory</description>

  <connectorRef type="ConnectorType">
    <filter>
      <q:equal>
        <q:path>connectorType</q:path>
        <q:value>com.evolveum.polygon.connector.ldap.LdapConnector</q:value>
      </q:equal>
    </filter>
  </connectorRef>

  <connectorConfiguration xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3">
    <icfc:configurationProperties xmlns:icfcldap="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.evolveum.polygon.connector-ldap/com.evolveum.polygon.connector.ldap.LdapConnector">
      <icfcldap:host>apacheds</icfcldap:host>
      <icfcldap:port>389</icfcldap:port>
      <icfcldap:bindDn>cn=admin,dc=example,dc=com</icfcldap:bindDn>
      <icfcldap:bindPassword>
        <clearValue>secret</clearValue>
      </icfcldap:bindPassword>
      <icfcldap:baseContext>dc=example,dc=com</icfcldap:baseContext>
      <icfcldap:pagingStrategy>auto</icfcldap:pagingStrategy>
      <icfcldap:vlvSortAttribute>uid</icfcldap:vlvSortAttribute>
      <icfcldap:operationalAttributes>memberOf</icfcldap:operationalAttributes>
      <icfcldap:operationalAttributes>createTimestamp</icfcldap:operationalAttributes>
    </icfc:configurationProperties>
    <icfc:resultsHandlerConfiguration>
      <icfc:enableNormalizingResultsHandler>false</icfc:enableNormalizingResultsHandler>
      <icfc:enableFilteredResultsHandler>false</icfc:enableFilteredResultsHandler>
      <icfc:enableAttributesToGetSearchResultsHandler>false</icfc:enableAttributesToGetSearchResultsHandler>
    </icfc:resultsHandlerConfiguration>
  </connectorConfiguration>

  <schemaHandling>
    <objectType>
      <kind>account</kind>
      <intent>default</intent>
      <displayName>Default Account</displayName>
      <default>true</default>
      <objectClass>ri:inetOrgPerson</objectClass>
      <attribute>
        <ref>ri:dn</ref>
        <displayName>Distinguished Name</displayName>
        <limitations>
          <access>
            <read>true</read>
            <add>true</add>
            <modify>true</modify>
          </access>
        </limitations>
        <matchingRule>mr:distinguishedName</matchingRule>
        <outbound>
          <source>
            <path>$user/name</path>
          </source>
          <expression>
            <script>
              <code>
                'uid=' + name + ',ou=people,dc=example,dc=com'
              </code>
            </script>
          </expression>
        </outbound>
      </attribute>
      <attribute>
        <ref>ri:uid</ref>
        <displayName>Login Name</displayName>
        <limitations>
          <access>
            <read>true</read>
            <add>true</add>
            <modify>true</modify>
          </access>
        </limitations>
        <outbound>
          <strength>weak</strength>
          <source>
            <path>$user/name</path>
          </source>
        </outbound>
      </attribute>
      <attribute>
        <ref>ri:cn</ref>
        <displayName>Common Name</displayName>
        <limitations>
          <access>
            <read>true</read>
            <add>true</add>
            <modify>true</modify>
          </access>
        </limitations>
        <outbound>
          <source>
            <path>fullName</path>
          </source>
        </outbound>
      </attribute>
      <attribute>
        <ref>ri:sn</ref>
        <displayName>Surname</displayName>
        <limitations>
          <access>
            <read>true</read>
            <add>true</add>
            <modify>true</modify>
          </access>
        </limitations>
        <outbound>
          <source>
            <path>familyName</path>
          </source>
        </outbound>
      </attribute>
      <attribute>
        <ref>ri:givenName</ref>
        <displayName>Given Name</displayName>
        <outbound>
          <source>
            <path>givenName</path>
          </source>
        </outbound>
      </attribute>
      <attribute>
        <ref>ri:mail</ref>
        <displayName>Email</displayName>
        <outbound>
          <source>
            <path>emailAddress</path>
          </source>
        </outbound>
      </attribute>
      <activation>
        <administrativeStatus>
          <outbound/>
        </administrativeStatus>
      </activation>
      <credentials>
        <password>
          <outbound/>
        </password>
      </credentials>
    </objectType>
  </schemaHandling>

  <capabilities>
    <cachingMetadata>
      <retrievalTimestamp>2025-01-01T00:00:00.000Z</retrievalTimestamp>
    </cachingMetadata>
    <native xmlns:cap="http://midpoint.evolveum.com/xml/ns/public/resource/capabilities-3">
      <cap:activation>
        <cap:status/>
      </cap:activation>
    </native>
  </capabilities>

  <synchronization>
    <objectSynchronization>
      <enabled>true</enabled>
      <correlation>
        <q:equal>
          <q:path>name</q:path>
          <expression>
            <path>$projection/attributes/uid</path>
          </expression>
        </q:equal>
      </correlation>
      <reaction>
        <situation>linked</situation>
        <synchronize>true</synchronize>
      </reaction>
      <reaction>
        <situation>deleted</situation>
        <action>
          <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#unlink</handlerUri>
        </action>
      </reaction>
      <reaction>
        <situation>unlinked</situation>
        <action>
          <handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link</handlerUri>
        </action>
      </reaction>
      <reaction>
        <situation>unmatched</situation>
      </reaction>
    </objectSynchronization>
  </synchronization>

</resource>
